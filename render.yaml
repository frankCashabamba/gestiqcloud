services:
  # ------------ BACKEND API (FastAPI) ------------
  - type: web
    name: gestiqcloud-api
    env: python
    region: oregon
    plan: starter
    branch: main
    rootDir: apps/backend
    autoDeploy: true
    domains:
      - api.gestiqcloud.com
    buildCommand: |
      pip install -U pip
      pip install -r requirements.txt
    startCommand: python prod.py
    envVars:
      - key: ENV
        value: production

      # Secrets
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET_KEY
        sync: false

      # URLs y CORS
      - key: FRONTEND_URL
        value: https://gestiqcloud.com
      - key: ADMIN_URL
        value: https://admin.gestiqcloud.com
      - key: CORS_ORIGINS
        value: '["https://gestiqcloud.com","https://admin.gestiqcloud.com"]'

      # Hosts permitidos (JSON)
      - key: ALLOWED_HOSTS
        value: '["api.gestiqcloud.com","*.onrender.com"]'

      # Cookies
      - key: COOKIE_DOMAIN
        value: .gestiqcloud.com
      - key: COOKIE_SECURE
        value: "true"
      - key: COOKIE_SAMESITE
        value: "none"

      # Otros requeridos por tu Settings
      - key: TENANT_NAMESPACE_UUID
        value: 0280249e-6707-40fb-8d60-1e8f3aea0f8e
      - key: IMPORTS_ENABLED
        value: "1"

  # ------------ FRONTEND TENANT (Vite) ------------
  - type: static
    name: gestiqcloud-tenant
    region: oregon
    plan: starter
    branch: main
    domains:
      - gestiqcloud.com
    buildCommand: |
      npm ci --prefix apps/tenant
      npm run build --prefix apps/tenant
    publishPath: apps/tenant/dist
    envVars:
      - key: VITE_API_URL
        value: https://api.gestiqcloud.com
      - key: VITE_BASE_PATH
        value: /
      - key: VITE_APP_URL
        value: https://gestiqcloud.com
      - key: VITE_ADMIN_URL
        value: https://admin.gestiqcloud.com

  # ------------ FRONTEND ADMIN (Vite) ------------
  - type: static
    name: gestiqcloud-admin
    region: oregon
    plan: starter
    branch: main
    domains:
      - admin.gestiqcloud.com
    buildCommand: |
      npm ci --prefix apps/admin
      npm run build --prefix apps/admin
    publishPath: apps/admin/dist
    envVars:
      - key: VITE_API_URL
        value: https://api.gestiqcloud.com
      - key: VITE_BASE_PATH
        value: /
      - key: VITE_APP_URL
        value: https://admin.gestiqcloud.com
      - key: VITE_TENANT_URL
        value: https://gestiqcloud.com
