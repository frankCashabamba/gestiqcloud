services:
  # ------------ BACKEND API (FastAPI) ------------
  - type: web
    name: gestiqcloud-api
    env: python
    region: oregon
    plan: starter
    branch: main
    rootDir: apps/backend
    autoDeploy: true
    domains:
      - api.gestiqcloud.com
    buildCommand: |
      pip install -U pip
      pip install -r requirements.txt
    startCommand: python prod.py
    # (opcional) Si tienes un endpoint de salud, añade esto:
    healthCheckPath: /health
    envVars:
      - key: ENV
        value: production

      # 🔐 Secrets
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET_KEY
        sync: false
      - key: SECRET_KEY
        sync: false

      # 🌐 URLs y CORS
      - key: FRONTEND_URL
        value: https://www.gestiqcloud.com
      - key: ADMIN_URL
        value: https://admin.gestiqcloud.com
      - key: CORS_ORIGINS
        value: https://gestiqcloud.com,https://www.gestiqcloud.com,https://admin.gestiqcloud.com,https://www.admin.gestiqcloud.com

      # ✅ Hosts permitidos (JSON)
      - key: ALLOWED_HOSTS
        value: '["api.gestiqcloud.com","*.onrender.com"]'

      # 🍪 Cookies
      - key: COOKIE_DOMAIN
        value: .gestiqcloud.com
      - key: COOKIE_SECURE
        value: "true"
      - key: COOKIE_SAMESITE
        value: "none"

      # ⚙️ Otros requeridos por tu Settings
      - key: TENANT_NAMESPACE_UUID
        value: 0280249e-6707-40fb-8d60-1e8f3aea0f8e
      - key: IMPORTS_ENABLED
        value: "1"

      # ✉️ Credenciales SMTP (obligatorias en prod)
      - key: EMAIL_HOST
        sync: false
      - key: EMAIL_PORT
        value: "587"
      - key: EMAIL_HOST_USER
        sync: false
      - key: EMAIL_HOST_PASSWORD
        sync: false
      - key: DEFAULT_FROM_EMAIL
        value: no-reply@gestiqcloud.com

      # 🔽 NUEVO: fija versión de Python (o usa 3.12.7 si lo prefieres)
      - key: PYTHON_VERSION
        value: 3.13.5

      # 🔽 NUEVO: fuerza wheels (evita compilar C en build)
      - key: PIP_ONLY_BINARY
        value: pandas,bcrypt,PyMuPDF,opencv-python-headless,psycopg2-binary,torch

  # ------------ FRONTEND TENANT (Vite) ------------
  - type: static
    name: gestiqcloud-tenant
    region: oregon
    plan: starter
    branch: main
    rootDir: apps/tenant
    domains:
      - gestiqcloud.com
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    buildCommand: |
      npm ci
      npm run build
    publishPath: dist
    envVars:
      - key: VITE_API_URL
        value: https://api.gestiqcloud.com
      - key: VITE_BASE_PATH
        value: /
      - key: VITE_TENANT_ORIGIN
        value: https://www.gestiqcloud.com
      - key: VITE_ADMIN_ORIGIN
        value: https://admin.gestiqcloud.com

  # ------------ FRONTEND ADMIN (Vite) ------------
  - type: static
    name: gestiqcloud-admin
    region: oregon
    plan: starter
    branch: main
    rootDir: apps/admin
    domains:
      - admin.gestiqcloud.com
    routes:
      - type: redirect
        source: /
        destination: /login
        status: 302
      - type: rewrite
        source: /*
        destination: /index.html
    buildCommand: |
      npm ci
      npm run build
    publishPath: dist
    envVars:
      - key: VITE_API_URL
        value: https://api.gestiqcloud.com
      - key: VITE_BASE_PATH
        value: /
      - key: VITE_ADMIN_ORIGIN
        value: https://admin.gestiqcloud.com
      - key: VITE_TENANT_ORIGIN
        value: https://gestiqcloud.com
