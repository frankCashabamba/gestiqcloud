server {
  listen 80;
  server_name _;

  # Increase limits for uploads if needed
  client_max_body_size 25m;

  # Proxy common headers
  proxy_set_header Host $http_host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;

  # Keep connection for HTTP/1.1 and WebSockets
  proxy_http_version 1.1;
  proxy_set_header Connection "";
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;

  # Mirror Cloudflare Worker behavior in prod
  # /v1/tenant/*  -> backend /api/v1/tenant/*
  location /v1/tenant/ {
    proxy_pass http://backend:8000/api/v1/tenant/;
    proxy_set_header Authorization $http_authorization;
  }

  # Generic /v1/*  -> backend /api/v1/* (covers /v1/modulos, /v1/me, etc.)
  location /v1/ {
    proxy_pass http://backend:8000/api/v1/;
    proxy_set_header Authorization $http_authorization;
  }

  # Direct API pass-through for /api/*
  location /api/ {
    proxy_pass http://backend:8000/api/;
    proxy_set_header Authorization $http_authorization;
  }

  # Do NOT serve Admin via edge; access Admin directly on :8081
  # Convenience: redirect to explicit port if someone hits /admin on edge
  location /admin/ {
    return 308 http://localhost:8081$request_uri;
  }

  # Everything else: serve the tenant PWA (static) via its container
  location / {
    proxy_pass http://tenant:8082;
  }
}
